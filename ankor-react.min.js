/**
 * @license almond 0.3.0 Copyright (c) 2011-2014, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */

(function(e,t){typeof define=="function"&&define.amd?define([],t):e.ankor=t()})(this,function(){var requirejs,require,define;return function(e){function h(e,t){return f.call(e,t)}function p(e,t){var n,r,i,s,o,a,f,l,h,p,d,v=t&&t.split("/"),m=u.map,g=m&&m["*"]||{};if(e&&e.charAt(0)===".")if(t){v=v.slice(0,v.length-1),e=e.split("/"),o=e.length-1,u.nodeIdCompat&&c.test(e[o])&&(e[o]=e[o].replace(c,"")),e=v.concat(e);for(h=0;h<e.length;h+=1){d=e[h];if(d===".")e.splice(h,1),h-=1;else if(d===".."){if(h===1&&(e[2]===".."||e[0]===".."))break;h>0&&(e.splice(h-1,2),h-=2)}}e=e.join("/")}else e.indexOf("./")===0&&(e=e.substring(2));if((v||g)&&m){n=e.split("/");for(h=n.length;h>0;h-=1){r=n.slice(0,h).join("/");if(v)for(p=v.length;p>0;p-=1){i=m[v.slice(0,p).join("/")];if(i){i=i[r];if(i){s=i,a=h;break}}}if(s)break;!f&&g&&g[r]&&(f=g[r],l=h)}!s&&f&&(s=f,a=l),s&&(n.splice(0,a,s),e=n.join("/"))}return e}function d(t,r){return function(){var i=l.call(arguments,0);return typeof i[0]!="string"&&i.length===1&&i.push(null),n.apply(e,i.concat([t,r]))}}function v(e){return function(t){return p(t,e)}}function m(e){return function(t){s[e]=t}}function g(n){if(h(o,n)){var r=o[n];delete o[n],a[n]=!0,t.apply(e,r)}if(!h(s,n)&&!h(a,n))throw new Error("No "+n);return s[n]}function y(e){var t,n=e?e.indexOf("!"):-1;return n>-1&&(t=e.substring(0,n),e=e.substring(n+1,e.length)),[t,e]}function b(e){return function(){return u&&u.config&&u.config[e]||{}}}var t,n,r,i,s={},o={},u={},a={},f=Object.prototype.hasOwnProperty,l=[].slice,c=/\.js$/;r=function(e,t){var n,r=y(e),i=r[0];return e=r[1],i&&(i=p(i,t),n=g(i)),i?n&&n.normalize?e=n.normalize(e,v(t)):e=p(e,t):(e=p(e,t),r=y(e),i=r[0],e=r[1],i&&(n=g(i))),{f:i?i+"!"+e:e,n:e,pr:i,p:n}},i={require:function(e){return d(e)},exports:function(e){var t=s[e];return typeof t!="undefined"?t:s[e]={}},module:function(e){return{id:e,uri:"",exports:s[e],config:b(e)}}},t=function(t,n,u,f){var l,c,p,v,y,b=[],w=typeof u,E;f=f||t;if(w==="undefined"||w==="function"){n=!n.length&&u.length?["require","exports","module"]:n;for(y=0;y<n.length;y+=1){v=r(n[y],f),c=v.f;if(c==="require")b[y]=i.require(t);else if(c==="exports")b[y]=i.exports(t),E=!0;else if(c==="module")l=b[y]=i.module(t);else if(h(s,c)||h(o,c)||h(a,c))b[y]=g(c);else{if(!v.p)throw new Error(t+" missing "+c);v.p.load(v.n,d(f,!0),m(c),{}),b[y]=s[c]}}p=u?u.apply(s[t],b):undefined;if(t)if(l&&l.exports!==e&&l.exports!==s[t])s[t]=l.exports;else if(p!==e||!E)s[t]=p}else t&&(s[t]=u)},requirejs=require=n=function(s,o,a,f,l){if(typeof s=="string")return i[s]?i[s](o):g(r(s,o).f);if(!s.splice){u=s,u.deps&&n(u.deps,u.callback);if(!o)return;o.splice?(s=o,o=a,a=null):s=e}return o=o||function(){},typeof a=="function"&&(a=f,f=l),f?t(e,s,o,a):setTimeout(function(){t(e,s,o,a)},4),n},n.config=function(e){return n(e)},requirejs._defined=s,define=function(e,t,n){t.splice||(n=t,t=[]),!h(s,e)&&!h(o,e)&&(o[e]=[e,t,n])},define.amd={jQuery:!0}}(),define("almond.js",function(){}),define("ankor/events/BaseEvent",[],function(){var e=function(e,t){this.path=e,this.eventSource=t};return e}),define("ankor/events/ActionEvent",["./BaseEvent"],function(e){var t=function(t,n,r,i){e.call(this,t,n),this.actionName=r,this.params=i};return t.prototype=new e,t}),define("ankor/events/ChangeEvent",["./BaseEvent"],function(e){var t=function(t,n,r,i,s){e.call(this,t,n),this.type=r,this.key=i,this.value=s};return t.prototype=new e,t.prototype.TYPE=t.TYPE={VALUE:"value",INSERT:"insert",DEL:"delete",REPLACE:"replace"},t}),define("ankor/transport/Message",[],function(){var e=function(e){this.event=e||null};return e}),define("ankor/PathSegment",[],function(){var e=function(t,n){var r=!1;for(var i in e.TYPE)if(e.TYPE.hasOwnProperty(i)&&n===e.TYPE[i]){r=!0;break}if(!r)throw new Error("Illegal PathSegment type");if(this.isProperty()&&(!t||typeof t!="string")||this.isIndex()&&typeof t!="number")throw new Error("Illegal PathSegment key");this.key=t,this.type=n};return e.TYPE={PROPERTY:0,INDEX:1},e.prototype.isProperty=function(){return this.type===e.TYPE.PROPERTY},e.prototype.isIndex=function(){return this.type===e.TYPE.INDEX},e}),define("ankor/Path",["./PathSegment"],function(e){var t=function(t){var n=[],r=t.split(".");for(var i=0,s;s=r[i];i++){var o=s.indexOf("[");if(o==-1)n.push(new e(s,e.TYPE.PROPERTY));else{var u=s.substr(0,o),a=s.substring(o+1,s.length-1).split("][");n.push(new e(u,e.TYPE.PROPERTY));for(var f=0,l;l=a[f];f++)l.indexOf("'")!=-1||l.indexOf('"')!=-1?n.push(new e(l.substring(1,l.length-1),e.TYPE.PROPERTY)):n.push(new e(parseInt(l),e.TYPE.INDEX))}}return n},n=function(e){this.segments=[],e instanceof Array?this.segments=e:typeof e=="string"&&(this.segments=t(e))};return n.prototype.toString=function(){var t="";for(var n=0,r;r=this.segments[n];n++)r.type===e.TYPE.PROPERTY?(n!=0&&(t+="."),t+=r.key):r.type===e.TYPE.INDEX&&(t+="["+r.key+"]");return t},n.prototype.append=function(e){var r=[];return e instanceof n?r=e.segments:e instanceof Array?r=e:typeof e=="string"&&(r=t(e)),new n(this.segments.concat(r))},n.prototype.appendIndex=function(t){var r=this.segments.slice(0);return r.push(new e(t,e.TYPE.INDEX)),new n(r)},n.prototype.parent=function(){return new n(this.segments.slice(0,-1))},n.prototype.root=function(){return new n([this.segments[0]])},n.prototype.propertyName=function(){return this.segments[this.segments.length-1].key},n.prototype.equals=function(e){return this.toString()==e.toString()},n.prototype.slice=function(e,t){return new n(this.segments.slice(e,t))},n}),define("ankor/transport/BaseTransport",["./Message","../Path","../events/BaseEvent","../events/ChangeEvent","../events/ActionEvent"],function(e,t,n,r,i){var s=function(){this.outgoingMessages=[],this.connected=!1};return s.prototype.onConnectionChange=function(e){},s.prototype.init=function(e){this.ankorSystem=e,this.utils=e.utils,this.onConnectionChange&&this.onConnectionChange(this.connected)},s.prototype.sendEvent=function(t){var n=new e(t);this.sendMessage(n)},s.prototype.sendMessage=function(e){var n=this.ankorSystem.stateProps;if(n){e.stateValues={};for(var r=0,i;i=n[r];r++)e.stateValues[i]=this.ankorSystem.model.getValue(new t(i))}this.outgoingMessages.push(e),this.ankorSystem.debug&&(e.event.pathString=e.event.path.toString(),console.log("OUT",e))},s.prototype.receiveMessage=function(e){this.ankorSystem.debug&&(e.event.pathString=e.event.path.toString(),console.log("IN",e)),this.ankorSystem.onIncomingEvent(e.event)},s.prototype.decodeMessage=function(s){var o=null,u=new t(s.property);s.change?o=new r(u,"ankorRemoteEvent",s.change.type,s.change.key,s.change.value):s.action?s.action instanceof Object?o=new i(u,"ankorRemoteEvent",s.action.name,s.action.params):o=new i(u,"ankorRemoteEvent",s.action,null):o=new n(u,"ankorRemoteEvent");var a=new e(o);return s.stateProps&&!0&&(this.ankorSystem.stateProps=a.stateProps=s.stateProps),a},s.prototype.encodeMessage=function(e){var t=e.event,n={property:t.path.toString()};return e.stateValues&&(n.stateValues=e.stateValues),t instanceof i?n.action={name:t.actionName,params:t.params}:t instanceof r?n.change={type:t.type,key:t.key,value:t.value}:e.connectParams&&(n.connectParams=e.connectParams),n},s}),define("ankor/transport/HttpPollingTransport",["./BaseTransport"],function(e){var t=function(t,n){e.call(this),this.endpoint=t,this.inFlight=null,this.pollingInterval=100,n&&n.pollingInterval!=undefined&&(this.pollingInterval=n.pollingInterval)};return t.prototype=new e,t.prototype.init=function(t){e.prototype.init(t),this.sendTimer=setTimeout(this.utils.hitch(this,"processOutgoingMessages"),this.pollingInterval)},t.prototype.sendMessage=function(t){e.prototype.sendMessage.call(this,t),this.inFlight||this.processOutgoingMessages()},t.prototype.processOutgoingMessages=function(){clearTimeout(this.sendTimer),this.inFlight=this.outgoingMessages,this.outgoingMessages=[];var e=[];for(var t=0,n;n=this.inFlight[t];t++)e.push(this.encodeMessage(n));this.utils.xhrPost(this.endpoint,{clientId:this.ankorSystem.senderId,messages:this.utils.jsonStringify(e)},this.utils.hitch(this,function(e,t){try{var n=this.utils.jsonParse(t)}catch(r){e=r}if(e)this.ankorSystem.debug&&console.log("Ankor HttpPollingTransport Error",e),this.outgoingMessages=this.inFlight.concat(this.outgoingMessages),this.connected&&(this.connected=!1,this.onConnectionChange&&this.onConnectionChange(this.connected));else{for(var i=0,s;s=n[i];i++){var o=this.decodeMessage(s);this.receiveMessage(o)}this.connected||(this.connected=!0,this.onConnectionChange&&this.onConnectionChange(this.connected))}this.inFlight=null,this.sendTimer=setTimeout(this.utils.hitch(this,"processOutgoingMessages"),this.pollingInterval)}))},t}),define("ankor/transport/WebSocketTransport",["./BaseTransport","./Message"],function(e,t){var n=function(t,n){e.call(this),this.options=n||{},this.endpointUri=t,this.endpoint=null,this.socket=null,this.reconnecting=!1,this._heartbeatInterval=this.options.heartbeatInterval||5e3,this._heartbeatTimer=null,this._reconnectBackoff=this.options.reconnectBackoff||250,this._reconnectDelay=this.reconnectBackoff,this._reconnectMaxDelay=this.options.reconnectMaxDelay||5e3};return n.prototype=new e,n.prototype.init=function(t){e.prototype.init(t),this.endpoint=this.endpointUri+"/"+t.senderId,this.ankorSystem.debug&&console.log("endpoint:",this.endpoint),this._connect(),window.onbeforeunload=this.utils.hitch(this,"_disconnect")},n.prototype.sendMessage=function(t){e.prototype.sendMessage.call(this,t),this.connected&&this._sendPendingMessages()},n.prototype._host=function(){var e=window.location.host+this.endpoint;return window.location.protocol=="http:"?e="ws://"+e:e="wss://"+e,e},n.prototype._webSocket=function(e){return"WebSocket"in window?new WebSocket(e):null},n.prototype._connect=function(){this._disconnect(),this.socket=this._webSocket(this._host(this.endpoint)),this.socket&&(this.socket.onopen=this.utils.hitch(this,"_onSocketOpen"),this.socket.onclose=this.utils.hitch(this,"_onSocketClose"),this.socket.onmessage=this.utils.hitch(this,"_onSocketMessage"),this.socket.onerror=this.utils.hitch(this,"_onSocketError"))},n.prototype._reconnect=function(){this._disconnect(),this.reconnecting?this._reconnectDelay=Math.min(this._reconnectDelay+this._reconnectBackoff,this._reconnectMaxDelay):(this.reconnecting=!0,this._reconnectDelay=this._reconnectBackoff),setTimeout(this.utils.hitch(this,function(){this.ankorSystem.debug&&console.log("WebSocket trying to reconnect (Delay = "+this._reconnectDelay+")"),this._connect()}),this._reconnectDelay)},n.prototype._disconnect=function(){this._stopHeartbeat(),this.connected=!1,this.onConnectionChange&&this.onConnectionChange(this.connected),this.socket&&(this.socket.onopen=null,this.socket.onclose=null,this.socket.onmessage=null,this.socket.onerror=null,this.socket.close(),this.socket=null)},n.prototype._onSocketOpen=function(){this.connected=!0,this.reconnecting=!1,this._startHeartbeat(),this.onConnectionChange&&this.onConnectionChange(this.connected);var e=new t({path:this.options.connectProperty});e.connectParams=this.options.connectParams,this._sendMessage(e),this._sendPendingMessages()},n.prototype._onSocketClose=function(){this._reconnect()},n.prototype._onSocketMessage=function(e){var t=this.decodeMessage(this.utils.jsonParse(e.data));this.receiveMessage(t)},n.prototype._onSocketError=function(e){this.ankorSystem.debug&&console.log("WebSocketTransport onError",e),this._reconnect()},n.prototype._sendPendingMessages=function(){if(this.connected){for(var e=0,t;t=this.outgoingMessages[e];e++)this._sendMessage(t);this.outgoingMessages=[]}},n.prototype._sendMessage=function(e){var t=this.utils.jsonStringify(this.encodeMessage(e));this.socket.send(t)},n.prototype._startHeartbeat=function(){this._heartbeatTimer||(this._heartbeatTimer=setTimeout(this.utils.hitch(this,"_onHeartbeat"),this._heartbeatInterval))},n.prototype._stopHeartbeat=function(){this._heartbeatTimer&&(clearTimeout(this._heartbeatTimer),this._heartbeatTimer=null)},n.prototype._onHeartbeat=function(){this.socket&&(this.ankorSystem.debug&&console.log("♥-beat"),this.socket.send(""),this._heartbeatTimer=setTimeout(this.utils.hitch(this,"_onHeartbeat"),this._heartbeatInterval))},n}),define("ankor/utils/base/uuid",[],function(){return function(){function t(){var t=Math.floor(Math.random()%1*Math.pow(2,32)),n=t.toString(e);while(n.length<8)n="0"+n;return n}var e=16,n="-",r="4",i="8",s=t(),o=t();o=o.substring(0,4)+n+r+o.substring(5,8);var u=t();u=i+u.substring(1,4)+n+u.substring(4,8);var a=t(),f=s+n+o+n+u+a;return f=f.toLowerCase(),f}}),define("ankor/utils/base/hitch",[],function(){return function(e,t){return typeof t=="string"&&(t=e[t]),function(){return t.apply(e,arguments||[])}}}),define("ankor/utils/base/jsonParse",[],function(){return function(jsonString){return typeof JSON!="undefined"?JSON.parse(jsonString):eval("("+jsonString+")")}}),define("ankor/utils/base/jsonStringify",[],function(){return function(e){if(typeof JSON!="undefined")return JSON.stringify(e);var t=function(e){return('"'+e.replace(/(["\\])/g,"\\$1")+'"').replace(/[\f]/g,"\\f").replace(/[\b]/g,"\\b").replace(/[\n]/g,"\\n").replace(/[\t]/g,"\\t").replace(/[\r]/g,"\\r")},n=function(e){var r,i=typeof e;if(i=="number")return isFinite(e)?e+"":"null";if(i=="boolean")return e+"";if(e===null)return"null";if(typeof e=="string")return t(e);if(e instanceof Array){var s=e.length,o=[];for(var u=0;u<s;u++){var a=e[u];r=n(a,u),typeof r!="string"&&(r="null"),o.push(r)}return"["+o.join(",")+"]"}var f=[];for(var u in e){var l;if(e.hasOwnProperty(u)){if(typeof u=="number")l='"'+u+'"';else{if(typeof u!="string")continue;l=t(u)}r=n(e[u],u);if(typeof r!="string")continue;f.push(l+":"+r)}}return"{"+f.join(",")+"}"};return n(e)}}),define("ankor/utils/base/xhrPost",[],function(){return function(e,t,n){var r="";for(var i in t){if(!t.hasOwnProperty(i))continue;r.length!=0&&(r+="&"),r+=encodeURIComponent(i),r+="=",r+=encodeURIComponent(t[i])}var s=new XMLHttpRequest;s.onreadystatechange=function(){if(s.readyState!=4)return;s.response?n(null,s.response):n(new Error("xhr error"))},s.open("POST",e),s.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),s.send(r)}}),define("ankor/utils/BaseUtils",["./base/uuid","./base/hitch","./base/jsonParse","./base/jsonStringify","./base/xhrPost"],function(e,t,n,r,i){return function(){this.uuid=e,this.hitch=t,this.jsonParse=n,this.jsonStringify=r,this.xhrPost=i}}),define("ankor/ListenerRegistry",[],function(){var e=0,t=function(e){this.ankorSystem=e,this.propListeners={children:{},listeners:{},ref:this.ankorSystem.getRef("")},this.treeListeners={children:{},listeners:{},ref:this.ankorSystem.getRef("")},this.actionListeners={children:{},listeners:{},ref:this.ankorSystem.getRef("")}};return t.prototype.addListener=function(t,n,r){var i=null;t=="propChange"?i=this._resolveListenersForPath(this.propListeners,n):t=="treeChange"?i=this._resolveListenersForPath(this.treeListeners,n):t=="action"&&(i=this._resolveListenersForPath(this.actionListeners,n));var s="#"+e++;return i.listeners[s]=r,{remove:function(){delete i.listeners[s]}}},t.prototype.triggerListeners=function(e,t){var n,r,i;r=this._resolveListenersForPath(this.treeListeners,e);while(r){for(n in r.listeners){if(!r.listeners.hasOwnProperty(n))continue;i=r.listeners[n],i(r.ref,t)}var s=r.ref.path;r=null,s.segments.length>0&&(r=this._resolveListenersForPath(this.treeListeners,s.parent()))}var o=[this._resolveListenersForPath(this.propListeners,e)],u={},a=!0;while(o.length>0){r=o.shift();if(!r.ref.isValid()){var f=r.ref.parent();while(!f.isValid())f=f.parent();u[f.path.toString()]=f.path;continue}for(n in r.listeners){if(!r.listeners.hasOwnProperty(n))continue;i=r.listeners[n],i(r.ref,t)}if(!a||t.type==t.TYPE.VALUE)for(var l in r.children){if(!r.children.hasOwnProperty(l))continue;o.push(r.children[l])}else{var c;if(t.type==t.TYPE.INSERT)c=t.key.toString(),c in r.children&&o.push(r.children[c]);else if(t.type==t.TYPE.REPLACE){var h=t.key;for(var p=0;p<t.value.length;p++)c=(h+p).toString(),c in r.children&&o.push(r.children[c])}}a=!1}for(var d in u){if(!u.hasOwnProperty(d))continue;this.removeInvalidListeners(u[d])}},t.prototype.triggerActionListeners=function(e,t){var n,r,i;r=this._resolveListenersForPath(this.actionListeners,e);for(n in r.listeners)i=r.listeners[n],i(r.ref,t)},t.prototype.removeInvalidListeners=function(e){var t=function(e){var n,r=[];for(n in e.children){if(!e.children.hasOwnProperty(n))continue;r.push(n)}for(var i=0;n=r[i];i++){var s=e.children[n];s.ref.isValid()?t(s):delete e.children[n]}};t(this._resolveListenersForPath(this.propListeners,e)),t(this._resolveListenersForPath(this.treeListeners,e))},t.prototype._resolveListenersForPath=function(e,t){var n=e,r=e.ref;for(var i=0,s;s=t.segments[i];i++){s.isProperty()?r=r.append(s.key):s.isIndex()&&(r=r.appendIndex(s.key));var o=s.key.toString();o in n.children||(n.children[o]={children:{},listeners:{},ref:r}),n=n.children[o]}return n},t}),define("ankor/ModelInterface",[],function(){var e=function(){};return e.prototype.getValue=function(e){throw new Error("ModelWrapper.getValue not implemented")},e.prototype.setValue=function(e,t){throw new Error("ModelWrapper.setValue not implemented")},e.prototype.isValid=function(e){throw new Error("ModelWrapper.isValid not implemented")},e.prototype.del=function(e){throw new Error("ModelWrapper.del not implemented")},e.prototype.insert=function(e,t,n){throw new Error("ModelWrapper.insert not implemented")},e.prototype.size=function(e){throw new Error("ModelWrapper.size not implemented")},e}),define("ankor/BigCacheController",[],function(){var e=function(e,t){this.model=e,this.size=1e3,this.order=[],this.indexMode=!1,t&&"size"in t&&(this.size=t.size),t&&t.indexMode&&(this.indexMode=!0)};return e.prototype._indexOf=function(e){var t=-1;if(Array.prototype.indexOf)t=this.order.indexOf(e);else for(var n=0;n<this.order.length;n++)if(this.order[n]==e){t=n;break}return t},e.prototype.add=function(e){this._indexOf(e)==-1&&this.order.push(e)},e.prototype.insert=function(e){if(!this.indexMode)throw new Error("BigCacheController.insert only available when in indexMode");var t=[];for(var n=0;n<this.order.length;n++){var r=this.order[n];r<e?t.push(r):t.push(r+1)}this.order=t,this.add(e)},e.prototype.remove=function(e){var t=[];for(var n=0;n<this.order.length;n++){var r=this.order[n];this.indexMode?r<e?t.push(r):r>e&&t.push(r-1):r!=e&&t.push(r)}this.order=t},e.prototype.touch=function(e){var t=this._indexOf(e);if(t==-1)return;this.order.splice(t,1),this.order.push(e)},e.prototype.cleanup=function(){while(this.order.length>this.size){var e=this.order.shift();delete this.model.model[e]}},e}),define("ankor/BigList",["./ModelInterface","./Path","./BigCacheController"],function(e,t,n){var r=function(e,r){this.model=r,this.cacheController=new n(r,{indexMode:!0}),this._loadTimer=null,this._loadQueue=[],this._loadPending={},this._size=e["@size"],this._chunk=e["@chunk"],this._substitute=e["@subst"];for(var i=0;i<e["@init"].length;i++)this.setValue((new t("")).appendIndex(i),e["@init"][i])};return r.prototype=new e,r.prototype.getValue=function(e){if(e.segments.length==0){var t=[];for(var n=0;n<this._size;n++)t.push(this.getValue([{type:"index",key:n}]));return t}var r=e.segments[0].key;if(r>=this._size)throw new Error("Index out of bounds");var i=!1;r in this.model.model?this.cacheController.touch(r):(this.model.model[r]=this._substitute,i=!0,this._requestMissing(r));var s=this.model.getValue(e);return i&&delete this.model.model[r],s},r.prototype.setValue=function(e,t){var n=e.segments[0].key;if(e.segments.length>1&&!(n in this.model.model))return;e.segments.length==1&&(n in this.model.model?this.cacheController.touch(n):this.cacheController.add(n),delete this._loadPending[n]),this.model.setValue(e,t),this.cacheController.cleanup()},r.prototype.isValid=function(e){if(e.segments.length==0)return!0;var t=e.segments[0].key,n=!1;t in this.model.model||(this.model.model[t]=this._substitute,n=!0);var r=this.model.isValid(e);return n&&delete this.model.model[t],r},r.prototype.del=function(e){var t=parseInt(e.segments[0].key);if(e.segments.length==1){t in this.model.model&&delete this.model.model[t],this._size--;var n={};for(var r in this.model.model){if(!this.model.model.hasOwnProperty(r))continue;var i=parseInt(r);i>t&&i--,n[i]=this.model.model[r]}this.model.model=n;var s=[];for(var o=0;o<this._loadQueue.length;o++){var u=this._loadQueue[o];u<t?s.push(u):u>t&&s.push(u-1)}this._loadQueue=s,this.cacheController.remove(t)}else t in this.model.model&&this.model.del(e)},r.prototype.insert=function(e,n,r){n=parseInt(n);if(e.segments.length==0){this._size++;var i={};for(var s in this.model.model){if(!this.model.model.hasOwnProperty(s))continue;var o=parseInt(s);o>=n&&o++,i[o]=this.model.model[s]}this.model.model=i;var u=[];for(var a=0;a<this._loadQueue.length;a++){var f=this._loadQueue[a];f<n?u.push(f):f>=n&&u.push(f+1)}this._loadQueue=u,this.cacheController.insert(n),this.setValue((new t("")).appendIndex(n),r)}else e.segments[0].key in this.model.model&&this.model.insert(e,n,r)},r.prototype.size=function(e){return e.segments.length==0?this._size:this.model.size(e)},r.prototype._requestMissing=function(e){if(this._loadPending[e])return;this._loadQueue.push(e),this._loadPending[e]=!0,this._loadTimer&&clearTimeout(this._loadTimer);var t=this;this._loadTimer=setTimeout(function(){var e,n=[],r=null;t._loadQueue.sort(function(e,t){return e-t});for(e=0;e<t._loadQueue.length;e++){var i=t._loadQueue[e];if(r==null||i>r+t._chunk-1){r=i,n.push(i);for(var s=0;s<t._chunk;s++)t._loadPending[i+s]=!0}}for(e=0;e<n.length;e++)t.model.baseRef.appendIndex(n[e]).fire("@missingProperty");t._loadQueue=[],t._loadTimer=null},100)},r}),define("ankor/BigMap",["./ModelInterface","./Path","./BigCacheController"],function(e,t,n){var r=function(e,r){this.model=r,this.cacheController=new n(r),this._loadTimer=null,this._loadPending={},this._size=e["@size"],this._substitute=e["@subst"];for(var i in e){if(!e.hasOwnProperty(i)||i=="@size"||i=="@subst")continue;this.setValue((new t("")).append(i),e[i])}};return r.prototype=new e,r.prototype.getValue=function(e){if(e.segments.length==0)return this.model.getValue(e);var t=e.segments[0].key,n=!1;t in this.model.model?this.cacheController.touch(t):(this.model.model[t]=this._substitute,n=!0,this._requestMissing(t));var r=this.model.getValue(e);return n&&delete this.model.model[t],r},r.prototype.setValue=function(e,t){var n=e.segments[0].key;if(e.segments.length>1&&!(n in this.model.model))return;e.segments.length==1&&(n in this.model.model?this.cacheController.touch(n):this.cacheController.add(n),delete this._loadPending[n]),this.model.setValue(e,t),this.cacheController.cleanup()},r.prototype.isValid=function(e){if(e.segments.length==0||e.segments.length==1)return!0;var t=e.segments[0].key,n=!1;t in this.model.model||(this.model.model[t]=this._substitute,n=!0);var r=this.model.isValid(e);return n&&delete this.model.model[t],r},r.prototype.del=function(e){var t=e.segments[0].key;e.segments.length==1?(t in this.model.model&&delete this.model.model[t],this._size--,this.cacheController.remove(t)):t in this.model.model&&this.model.del(e)},r.prototype.insert=function(e,t,n){if(e.segments.length==0)throw new Error("Insert only works for Arrays");e.segments[0].key in this.model.model&&this.model.insert(e,t,n)},r.prototype.size=function(e){return e.segments.length==0?this._size:this.model.size(e)},r.prototype._requestMissing=function(e){if(this._loadPending[e])return;this._loadPending[e]=!0,this.model.baseRef.append(e).fire("@missingProperty")},r}),define("ankor/Model",["./ModelInterface","./BigList","./BigMap"],function(e,t,n){function i(e,s,o,u){if(o instanceof Array)if(o.length==1&&o[0]instanceof Object&&"@chunk"in o[0]&&"@init"in o[0]&&"@size"in o[0]&&"@subst"in o[0])e[s]=new t(o[0],new r(this.baseRef.append(u)));else{e[s]=[];for(var a=0;a<o.length;a++)i.call(this,e[s],a,o[a],u.appendIndex(a))}else if(o instanceof Object)if("@subst"in o&&"@size"in o)e[s]=new n(o,new r(this.baseRef.append(u)));else{e[s]={};for(var f in o){if(!o.hasOwnProperty(f))continue;i.call(this,e[s],f,o[f],u.append(f))}}else e[s]=o}var r=function(e){this.baseRef=e,this.model={}};return r.prototype=new e,r.prototype.getValue=function(t){var n=this.model;for(var r=0,i;i=t.segments[r];r++){n!=undefined&&(n=n[i.key]);if(n instanceof e)return n.getValue(t.slice(r+1))}return n},r.prototype.setValue=function(t,n){var r=t.parent(),s=this.model;for(var o=0,u;u=r.segments[o];o++){s=s[u.key];if(s===undefined||s===null)throw new Error("setValue encountered undefined or null in path");if(s instanceof e){s.setValue(t.slice(o+1),n);return}}i.call(this,s,t.propertyName(),n,t)},r.prototype.isValid=function(t){var n=!0,r=this.model;for(var i=0,s;s=t.segments[i];i++){if(r===null||r[s.key]===undefined){n=!1;break}r=r[s.key];if(r instanceof e)return r.isValid(t.slice(i+1))}return n},r.prototype.del=function(t){var n=t.parent(),r=this.model;for(var i=0,s;s=n.segments[i];i++){r=r[s.key];if(r===undefined||r===null)throw new Error("del encountered undefined or null in path");if(r instanceof e){r.del(t.slice(i+1));return}}var o=t.segments[t.segments.length-1];r instanceof Array?r.splice(o.key,1):delete r[o.key]},r.prototype.insert=function(t,n,r){var i=this.model;for(var s=0,o;o=t.segments[s];s++){i!=undefined&&(i=i[o.key]);if(i instanceof e){i.insert(t.slice(s+1),n,r);return}}if(!(i instanceof Array))throw new Error("Insert only works for Arrays");i.splice(n,0,r)},r.prototype.size=function(t){var n=this.model;for(var r=0,i;i=t.segments[r];r++){n!=undefined&&(n=n[i.key]);if(n instanceof e)return n.size(t.slice(r+1))}if(n instanceof Array)return n.length;if(n instanceof Object){var s=0;for(var o in n)s++;return s}return-1},r}),define("ankor/Ref",["./events/BaseEvent","./events/ChangeEvent","./events/ActionEvent"],function(e,t,n){var r=function(e,t){this.ankorSystem=e,this.path=t};return r.prototype.append=function(e){return new r(this.ankorSystem,this.path.append(e))},r.prototype.appendPath=r.prototype.append,r.prototype.appendIndex=function(e){return new r(this.ankorSystem,this.path.appendIndex(e))},r.prototype.parent=function(){return new r(this.ankorSystem,this.path.parent())},r.prototype.root=function(){return new r(this.ankorSystem,this.path.root())},r.prototype.propertyName=function(){return this.path.propertyName()},r.prototype.equals=function(e){return this.path.equals(e.path)},r.prototype.getValue=function(){return this.ankorSystem.model.getValue(this.path)},r.prototype.setValue=function(e,n){this.ankorSystem.model.setValue(this.path,e),e===null&&this.ankorSystem.removeInvalidListeners(this.path.parent());var r=new t(this.path,n,t.TYPE.VALUE,null,e);this.ankorSystem.triggerListeners(this.path,r),this.ankorSystem.transport.sendEvent(r)},r.prototype.del=function(e){this.ankorSystem.model.del(this.path);var n=this.path.parent();this.ankorSystem.removeInvalidListeners(n);var r=new t(n,e,t.TYPE.DEL,this.propertyName(),null);this.ankorSystem.triggerListeners(n,r),this.ankorSystem.transport.sendEvent(r)},r.prototype.insert=function(e,n,r){this.ankorSystem.model.insert(this.path,e,n);var i=new t(this.path,r,t.TYPE.INSERT,e,n);this.ankorSystem.triggerListeners(this.path,i),this.ankorSystem.transport.sendEvent(i)},r.prototype.size=function(){return this.ankorSystem.model.size(this.path)},r.prototype.isValid=function(){return this.ankorSystem.model.isValid(this.path)},r.prototype._handleEvent=function(e){if(e instanceof t){if(e.type===t.TYPE.VALUE)this.ankorSystem.model.setValue(this.path,e.value),s===null&&this.ankorSystem.removeInvalidListeners(this.path.parent()),this.ankorSystem.triggerListeners(this.path,e);else if(e.type===t.TYPE.DEL)this.ankorSystem.model.del(this.path.append(e.key.toString())),this.ankorSystem.removeInvalidListeners(this.path),this.ankorSystem.triggerListeners(this.path,e);else if(e.type===t.TYPE.INSERT)this.ankorSystem.model.insert(this.path,e.key.toString(),e.value),this.ankorSystem.triggerListeners(this.path,e);else if(e.type===t.TYPE.REPLACE){for(var r=0;r<e.value.length;r++){var i=this.path.appendIndex(e.key+r),s=e.value[r];this.ankorSystem.model.setValue(i,s)}this.ankorSystem.removeInvalidListeners(this.path),this.ankorSystem.triggerListeners(this.path,e)}}else e instanceof n&&this.ankorSystem.triggerListeners(this.path,e)},r.prototype.fire=function(e,t){var r=new n(this.path,null,e,t);this.ankorSystem.transport.sendEvent(r)},r.prototype.addPropChangeListener=function(e){return this.ankorSystem.addListener("propChange",this.path,e)},r.prototype.addTreeChangeListener=function(e){return this.ankorSystem.addListener("treeChange",this.path,e)},r.prototype.addActionListener=function(e){return this.ankorSystem.addListener("action",this.path,e)},r}),define("ankor/AnkorSystem",["./ListenerRegistry","./Model","./Path","./Ref","./events/BaseEvent","./events/ChangeEvent","./events/ActionEvent"],function(e,t,n,r,i,s,o){var u=function(n){if(!n)throw new Error("AnkorSystem missing options");if(!n.utils)throw new Error("AnkorSystem missing utils");if(!n.transport)throw new Error("AnkorSystem missing transport");this.debug=n.debug||!1,this.utils=n.utils,this.senderId=this.utils.uuid(),this.modelId=n.modelId||this.utils.uuid(),this.transport=n.transport,this.model=new t(this.getRef("")),this.listenerRegistry=new e(this),this.transport.init(this)};return u.prototype.getRef=function(e){return e instanceof n||(e=new n(e)),new r(this,e)},u.prototype.addListener=function(e,t,n){return this.listenerRegistry.addListener(e,t,n)},u.prototype.triggerListeners=function(e,t){t instanceof s?this.listenerRegistry.triggerListeners(e,t):t instanceof o&&this.listenerRegistry.triggerActionListeners(e,t)},u.prototype.removeInvalidListeners=function(e){this.listenerRegistry.removeInvalidListeners(e)},u.prototype.onIncomingEvent=function(e){var t=this.getRef(e.path);t._handleEvent(e)},u}),define("ankor/ankor",["./events/ActionEvent","./events/BaseEvent","./events/ChangeEvent","./transport/BaseTransport","./transport/HttpPollingTransport","./transport/Message","./transport/WebSocketTransport","./utils/BaseUtils","./AnkorSystem","./BigCacheController","./BigList","./BigMap","./ListenerRegistry","./Model","./ModelInterface","./Path","./PathSegment","./Ref"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g){var y={adapters:{},events:{ActionEvent:e,BaseEvent:t,ChangeEvent:n},transport:{BaseTransport:r,HttpPollingTransport:i,Message:s,WebSocketTransport:o},utils:{BaseUtils:u},AnkorSystem:a,BigCacheController:f,BigList:l,BigMap:c,ListenerRegistry:h,Model:p,ModelInterface:d,Path:v,PathSegment:m,Ref:g};return y}),require("ankor/ankor")});